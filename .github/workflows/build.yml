name: Build

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: "Package name of the game:"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # Updated to v4

      - name: Clear problematic cache
        run: |
          rm -rf ~/.actions/toolcache
          rm -rf ~/.actions/actions

      - name: Set up Java
        uses: actions/setup-java@v4  # Updated to v4
        with:
          distribution: temurin
          java-version: 11
          cache: gradle

      - name: Build and replace placeholders
        run: |
          chmod +x ./gradlew
          ESCAPED_PKG=$(echo "${{ github.event.inputs.package_name }}" | sed 's/[\/&]/\\&/g')
          sed -i "s/moduleDescription = \".*\"/moduleDescription = \"($ESCAPED_PKG)\"/g" module.gradle
          sed -i "s/com\.game\.packagename/$ESCAPED_PKG/g" module/src/main/cpp/game.h
          ./gradlew :module:assembleRelease || echo "Build failed" && exit 1

      - name: Verify artifacts
        run: |
          mkdir -p out/magisk_module_release/  # Ensure directory exists
          touch out/magisk_module_release/test.txt  # Create test file

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zygisk-il2cppdumper
          path: out/magisk_module_release/
